#!/usr/bin/env python3
import sys
import pandas as pd

glycosyltransferases=[
#http://www.cazy.org/GlycosylTransferases
    '2.-.-.-','2.4.-.-','2.4.1.-','2.4.1.1','2.4.1.11','2.4.1.12',
    '2.4.1.13','2.4.1.14','2.4.1.15','2.4.1.16','2.4.1.17','2.4.1.21',
    '2.4.1.22','2.4.1.26','2.4.1.27','2.4.1.32','2.4.1.34','2.4.1.35',
    '2.4.1.36','2.4.1.37','2.4.1.38','2.4.1.40','2.4.1.41','2.4.1.44',
    '2.4.1.46','2.4.1.47','2.4.1.56','2.4.1.57','2.4.1.58','2.4.1.65',
    '2.4.1.68','2.4.1.69','2.4.1.80','2.4.1.81','2.4.1.83','2.4.1.85',
    '2.4.1.87','2.4.1.88','2.4.1.90','2.4.1.91','2.4.1.92','2.4.1.101',
    '2.4.1.102','2.4.1.109','2.4.1.115','2.4.1.117','2.4.1.119','2.4.1.120',
    '2.4.1.121','2.4.1.122','2.4.1.123','2.4.1.128','2.4.1.129','2.4.1.131',
    '2.4.1.133','2.4.1.135','2.4.1.142','2.4.1.143','2.4.1.144','2.4.1.145',
    '2.4.1.149','2.4.1.150','2.4.1.152','2.4.1.155','2.4.1.157','2.4.1.159',
    '2.4.1.170','2.4.1.173','2.4.1.174','2.4.1.175','2.4.1.177','2.4.1.182',
    '2.4.1.183','2.4.1.185','2.4.1.186','2.4.1.194','2.4.1.195','2.4.1.198',
    '2.4.1.199','2.4.1.202','2.4.1.203','2.4.1.208','2.4.1.210','2.4.1.212',
    '2.4.1.213','2.4.1.214','2.4.1.215','2.4.1.217','2.4.1.221','2.4.1.222',
    '2.4.1.223','2.4.1.224','2.4.1.225','2.4.1.227','2.4.1.231','2.4.1.237',
    '2.4.1.238','2.4.1.241','2.4.1.242','2.4.1.245','2.4.1.252','2.4.1.253',
    '2.4.1.255','2.4.1.256','2.4.1.257','2.4.1.258','2.4.1.259','2.4.1.260',
    '2.4.1.265','2.4.1.266','2.4.1.267','2.4.1.270','2.4.1.275','2.4.1.276',
    '2.4.1.283','2.4.1.285','2.4.1.286','2.4.1.288','2.4.1.289','2.4.1.290',
    '2.4.1.302','2.4.1.305','2.4.1.312','2.4.1.342','2.4.1.351','2.4.1.360',
    '2.4.1.364','2.4.1.365','2.4.1.374','2.4.2.-','2.4.2.26','2.4.2.38',
    '2.4.2.39','2.4.2.40','2.4.2.41','2.4.2.43','2.4.2.62','2.4.99.-',
    '2.4.99.1','2.4.99.3','2.4.99.4','2.4.99.6','2.4.99.7','2.4.99.8',
    '2.4.99.9','2.4.99.18','2.4.99.19','3.1.-.-','3.5.1.-',
#from others
    '2.4.1.345','2.4.99.12','2.4.99.13','2.4.99.14','2.4.99.15'
]

del_kegg_lv2=[
    'Amino acid metabolism',
    'Nucleotide metabolism',
    'Metabolism of other amino acids'
]

def isGlycosyltransferases(ec_l):
    Judge=0
    if isinstance(ec_l,float):
        return Judge
    elif len(ec_l)==1:
        if ec_l[0] in glycosyltransferases:
            Judge=1
    else:
        for ec in ec_l:
            if ec in glycosyltransferases:
                Judge=1
                return Judge
    return Judge

#input: VIBRANT_AMG_ylbh_votus_kegg_annoted.tsv
def filtAMG(vb_amg_kegg_f:str,amg_uniq_list_f:str):
    df=pd.read_csv(vb_amg_kegg_f,sep='\t')
    df=df[df['level_1']=='Metabolism']
    df=df[~df['level_2'].isin(del_kegg_lv2)]
    df['EC']=df['KO name'].str.extract(r'\[EC:(.*?)\]')
    df['EC']=df['EC'].str.split()
    df['isGT']=df['EC'].apply(lambda x:isGlycosyltransferases(x))
    df=df[df['isGT']!=1]
    df=df['protein'].drop_duplicates()
    df.to_csv(amg_uniq_list_f,sep='\t',index=False)
    return 0

if __name__=='__main__':
    filtAMG(sys.argv[1],sys.argv[2])
