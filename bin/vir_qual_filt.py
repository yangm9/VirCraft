#!/usr/bin/env python3

import sys
import pandas as pd
from collections import defaultdict

# Get CheckV provirus coordinate information
def collect_provirus_coordinates(checkv_proviruses_fna: str) -> pd.DataFrame:
    contig_partials = defaultdict(list)
    contig_ranges = defaultdict(list)
    with open(checkv_proviruses_fna) as fh:
        for line in fh:
            if not line.startswith(">"):
                continue
            header = line[1:].strip()
            name_part,range_part = header.split()
            *contig_parts,partial_id = name_part.split("_")
            contig = "_".join(contig_parts)
            partial = f"fragment_{partial_id}"
            nucl_range = range_part.split("/")[0]
            contig_partials[contig].append(partial)
            contig_ranges[contig].append(nucl_range)
    records = []
    for contig in contig_partials:
        tmp_dict = {
            "Contig":contig,
            "ckv_partial":",".join(contig_partials[contig]),
            "ckv_nucl_range":",".join(contig_ranges[contig])
        }
        records.append(tmp_dict)
    return pd.DataFrame(records)

# Merge the vir_score_tsv file and vir_qual_tsv file by contig id
def merge_score_qual(vir_score_tsv: str, checkv_dir: str) -> pd.DataFrame:
    checkv_quality_tsv = f'{checkv_dir}/quality_summary.tsv'
    checkv_proviruses_fna = f'{checkv_dir}/proviruses.fna'
    score_df = pd.read_csv(vir_score_tsv, sep="\t")
    checkv_quality_df = pd.read_csv(checkv_quality_tsv, sep="\t")
    checkv_quality_df.rename(columns={'contig_id': 'Contig'}, inplace=True)
    checkv_provirus_df = collect_provirus_coordinates(checkv_proviruses_fna)
    checkv_df = pd.merge(checkv_quality_df, checkv_provirus_df, how="left", on="Contig")
    merged_df = pd.merge(checkv_df, score_df, how="right", on="Contig")
    #merged_df.to_csv(vir_qual_score_tsv, sep="\t", index=False)
    return merged_df

# Integrate the provirus information generated by each tools, and intersect all these range.
def identify_provirus(vir_checkv_score_df: pd.DataFrame) -> pd.DataFrame:
    def parse_ranges(r):
        if pd.isna(r): return []
        out = []
        for x in str(r).split(","):
            s, e = x.split("-")
            out.append((int(s), int(e)))
        return out
    def intersect(rs):
        s = max(r[0] for r in rs)
        e = min(r[1] for r in rs)
        if s <= e: return (s, e)
        return None
    def merge_ranges_by_host_rate(ranges, contig_length, max_gap=20000, max_host_rate=0.3):
        if len(ranges) <= 1:
            return ranges
        ranges = sorted(ranges, key=lambda x: x[0])
        merged = [ranges[0]]
        for cur in ranges[1:]:
            prev = merged[-1]
            gap = cur[0] - prev[1] - 1
            if gap <= max_gap:
                new_start, new_end = prev[0], cur[1]
                host_len = (new_start - 1) + gap + (contig_length - new_end)
                if host_len / contig_length <= max_host_rate:
                    merged[-1] = (new_start, new_end)
                else:
                    merged.append(cur)
            else:
                merged.append(cur)
        return merged
    priority = ["CheckV", "geNomad", "VIBRANT", "VirSorter2"]
    is_provirus = []
    #provirus_range = []
    provirus_source = []
    provirus_range = []
    host_rate = []
    for _, row in vir_checkv_score_df.iterrows():
        tool_ranges = {}
        if row.get("provirus") == "Yes":
            tool_ranges["CheckV"] = parse_ranges(row.get("ckv_nucl_range"))
        if isinstance(row.get("vs2_region"), str) and "partial" in row.get("vs2_region"):
            tool_ranges["VirSorter2"] = parse_ranges(row.get("vs2_nucl_range"))
        if pd.notna(row.get("vb_partial")):
            tool_ranges["VIBRANT"] = parse_ranges(row.get("vb_nucl_range"))
        if row.get("gn_topology") == "Provirus":
            tool_ranges["geNomad"] = parse_ranges(row.get("gn_coordinates"))
        tool_ranges = {k: v for k, v in tool_ranges.items() if v}
        if not tool_ranges:
            is_provirus.append(0)
            provirus_range.append(None)
            provirus_source.append(None)
            host_rate.append(0)
            continue
        for k in tool_ranges:
            tool_ranges[k] = merge_ranges_by_host_rate(tool_ranges[k], row["contig_length"])
        if len(tool_ranges) >= 2:
            all_ranges = [r for rs in tool_ranges.values() for r in rs]
            inter = intersect(all_ranges)
            if inter:
                final = inter
                src = ",".join(k for k in priority if k in tool_ranges)
            else:
                for k in priority:
                    if k in tool_ranges:
                        final = tool_ranges[k]
                        src = k
                        break
        else:
            k = list(tool_ranges.keys())[0]
            final = tool_ranges[k]
            src = k
        if isinstance(final, list):
            viral_len = sum(e - s + 1 for s, e in final)
            #provirus_length.append(viral_len)
            provirus_range.append(",".join(f"{s}-{e}" for s, e in final))
        else:
            viral_len = final[1] - final[0] + 1
            #provirus_length.append(viral_len)
            provirus_range.append(f"{final[0]}-{final[1]}")
        is_provirus.append(1)
        provirus_source.append(src)
        host_rate.append(1 - viral_len / row["contig_length"])
    vir_checkv_score_df["is_provirus"] = is_provirus
    vir_checkv_score_df["provirus_range"] = provirus_range
    #vir_checkv_score_df["provirus_length"] = provirus_length
    vir_checkv_score_df["provirus_source"] = provirus_source
    vir_checkv_score_df["host_rate"] = host_rate
    return vir_checkv_score_df

#df = identify_provirus(vir_score_tsv, checkv_dir)
#df.to_csv('test.xls', sep="\t", index=False)

# Run full provirus identification pipeline:
# 1) merge VirSorter2/VIBRANT/geNomad/DeepVirFinder scores with CheckV quality results
# 2) collect CheckV provirus coordinates from proviruses.fna
# 3) identify provirus regions using multi-tool integration rules
# 4) write final provirus annotation table to vir_qual_score_tsv
def calculate_provirus(vir_score_tsv: str, checkv_dir: str) -> pd.DataFrame:
    merged_df = merge_score_qual(vir_score_tsv, checkv_dir)
    final_df = identify_provirus(merged_df)
    return final_df

# ==========================================
# filt_checkv
# input: quality_summary.tsv, namely checkv result file
# methods: the vs2-vb-dvf-gn identified viral contigs with a length of â‰¥ 2 kb and .
# output: virus_quality_summary.filt.tsv and provir_quality_summary.filt.tsv
# return: viral ID list and proviral ID list
def filt_checkv(vir_qual_score_df: pd.DataFrame):
    provirus_vctg_filt_condition = 'contig_length >= 5000 and is_provirus == 1'
    complete_vctg_filt_condition = 'contig_length >= 1500 and is_provirus == 0 and checkv_quality == "Complete"'
    vctg_for_binning_filt_condition = 'contig_length >= 5000 and is_provirus == 0 and checkv_quality != "Complete"'
    complete_vctg_list = vir_qual_score_df.query(complete_vctg_filt_condition)['Contig'].tolist()
    provirus_vctg_list = vir_qual_score_df.query(provirus_vctg_filt_condition)['Contig'].tolist()
    vctg_for_binning_list = vir_qual_score_df.query(vctg_for_binning_filt_condition)['Contig'].tolist()
    return complete_vctg_list, provirus_vctg_list, vctg_for_binning_list

# extracr sequences from FASTA file according to ID list
def extr_ctgs(id_list, in_fa, out_fa):
    IFA = open(in_fa)
    OFA = open(out_fa,'w')
    seq_id = ''
    curr_id = ''
    for line in IFA:
        line = line.strip()
        if line.startswith('>'):
            seq_id = line.lstrip('>')
            if seq_id in id_list:
                OFA.write(f'{line}\n')
                curr_id = seq_id
        else:
            if seq_id == curr_id:
                OFA.write(f'{line}\n')
    IFA.close()
    OFA.close()
    return 0

def filt_posi_ctgs(vir_score_tsv: str, checkv_dir: str, viral_filt_ctg_fna: str, viral_posi_ctg_fna: str):
    final_df = calculate_provirus(vir_score_tsv, checkv_dir)
    vir_qual_score_tsv = vir_score_tsv.replace('.tsv', '.qual.tsv')
    final_df.to_csv(vir_qual_score_tsv, sep="\t", index=False)
    complete_vctg_list, provirus_vctg_list, vctg_for_binning_list = filt_checkv(final_df)
    virus_id_list = complete_vctg_list + provirus_vctg_list + vctg_for_binning_list
    extr_ctgs(virus_id_list, viral_filt_ctg_fna, viral_posi_ctg_fna)
    complete_vctg_fna = viral_posi_ctg_fna.replace('.fna', '_complete.fna')
    extr_ctgs(complete_vctg_list, viral_filt_ctg_fna, complete_vctg_fna)
    provirus_vctg_fna = viral_posi_ctg_fna.replace('.fna', '_provirus.fna')
    extr_ctgs(provirus_vctg_list, viral_filt_ctg_fna, provirus_vctg_fna)
    viral_binning_ctg_fna = viral_posi_ctg_fna.replace('.fna', '_for_binning.fna')
    extr_ctgs(vctg_for_binning_list, viral_filt_ctg_fna, viral_binning_ctg_fna)
    return 0

if __name__  == '__main__':
    if len(sys.argv) == 5:
        filt_posi_ctgs(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
    else:
        print(f'Usage: {sys.argv[0]} all_viral_ctgs.score.permissive.qual.tsv checkv_dir viral_filt_ctg.fna viral_positive_ctg.fna')
